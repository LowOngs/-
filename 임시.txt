/* ===== Ongs Partner Console â€“ Code.gs (v11.3 ì§‘ê³„ ì—°ê²° ë²„ì „) ===== */

/** íŒŒíŠ¸ë„ˆ ëª©ë¡ */
var PARTNERS = [
  'amazon','ebay','target','mercadolibre','flipkart',
  'amazon_in','shopee','lazada','aliexpress','otto','zalando','allegro'
];

/** ê¸°ë³¸ íƒ€ì„ì¡´ */
var TZ = 'Asia/Seoul';

/** ğŸŸ¢ ì—¬ê¸°ì— êµ¬ê¸€ ì‹œíŠ¸ IDë¥¼ ë„£ìœ¼ì„¸ìš” */
var SPREADSHEET_ID = 'ì—¬ê¸°ì—_ì‹œíŠ¸_ID_ë¶™ì—¬ë„£ê¸°';  
var SHEET_NAME     = 'stats';

/** ê´€ë¦¬ì íŒë³„ */
function isAdmin_(){
  var me = Session.getActiveUser().getEmail();
  return !!me;
}

/** ì—”íŠ¸ë¦¬ */
function doGet(e){
  var cmd = (e && e.parameter && e.parameter.cmd) || '';
  if (cmd === 'map') return jsonActiveMap_();
  if (cmd === 'go')  return handleRedirect_(e);
  if (!isAdmin_()) return HtmlService.createHtmlOutput('<h3>Forbidden</h3>');
  return HtmlService.createHtmlOutputFromFile('admin_dash')
    .setTitle('Ongs Â· Partner Console â€“ v11.3')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

/** ìƒíƒœ ì¡°íšŒ */
function getPartnerState(){
  var props = PropertiesService.getScriptProperties();
  var out = {};
  PARTNERS.forEach(function(pid){
    var url = props.getProperty('url_'+pid) || '';
    var onProp = props.getProperty('on_'+pid);
    var on  = (onProp == null) ? true : (onProp === '1');
    out[pid] = { url:url, on:on };
  });
  return out;
}

/** URL ì €ì¥ */
function setPartnerUrl(pid, url){
  if (!isAdmin_()) throw new Error('forbidden');
  if (PARTNERS.indexOf(pid) < 0) throw new Error('unknown pid');
  var u = (url || '').trim();
  PropertiesService.getScriptProperties().setProperty('url_'+pid, u);
  return { ok:true, pid:pid, url:u };
}

/** ON/OFF ì„¤ì • */
function setPartnerOn(pid, on){
  if (!isAdmin_()) throw new Error('forbidden');
  if (PARTNERS.indexOf(pid) < 0) throw new Error('unknown pid');
  var props = PropertiesService.getScriptProperties();
  var curUrl = (props.getProperty('url_'+pid) || '').trim();
  if (on === false && curUrl) {
    throw new Error('íŠ¸ë˜í‚¹ ë§í¬ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ë¨¼ì € URLì„ ë¹„ìš°ê³  ì €ì¥í•œ ë’¤ OFFë¡œ ì „í™˜í•˜ì„¸ìš”.');
  }
  props.setProperty('on_'+pid, on ? '1' : '0');
  return { ok:true, pid:pid, on:!!on, state:getPartnerState() };
}

/** ê°€ì ¯ìš© í™œì„± ë§µ(JSON) */
function jsonActiveMap_(){
  var state = getPartnerState();
  var map = {};
  Object.keys(state).forEach(function(pid){
    var st  = state[pid] || {};
    var url = (st.url || '').trim();
    var on  = !!st.on;
    map[pid] = { on:on, clickable:(on && !!url), href:url };
  });
  return ContentService.createTextOutput(JSON.stringify(map))
    .setMimeType(ContentService.MimeType.JSON);
}

/** ë°©ë¬¸ì ë¦¬ë””ë ‰ì…˜ */
function handleRedirect_(e){
  var raw = (e && e.parameter && (e.parameter.pid || e.parameter.partner)) || '';
  var pid = String(raw || '').trim().toLowerCase();
  var props = PropertiesService.getScriptProperties();
  var onProp = pid ? props.getProperty('on_'+pid) : null;
  var url = pid ? (props.getProperty('url_'+pid) || '') : '';
  var on = (onProp == null) ? true : (onProp === '1');
  if (!pid){
    return HtmlService.createHtmlOutput('<meta name="referrer" content="no-referrer"><h3>Unknown partner.</h3>');
  }
  if (!on){
    return HtmlService.createHtmlOutput('<meta name="referrer" content="no-referrer"><h3>Inactive partner button (OFF).</h3>');
  }
  if (!url){
    return HtmlService.createHtmlOutput('<meta name="referrer" content="no-referrer"><h3>Partner is ON but link not configured yet.</h3>');
  }
  bumpClick_(pid);
  var html = '<meta name="referrer" content="no-referrer">'
           + '<script>location.replace(' + JSON.stringify(url) + ');</script>'
           + '<noscript><a href='+JSON.stringify(url)+'>Continue</a></noscript>';
  return HtmlService.createHtmlOutput(html);
}

/* =========================
 * ğŸŸ¢ í´ë¦­ ì§‘ê³„ ë¡œì§
 * ========================= */
function getMonthlyStatsRPC(){
  var mk = monthKey_();
  var counts = {};
  PARTNERS.forEach(function(pid){ counts[pid]=0; });
  var sh = getSheet_();
  if (!sh) return { yyyymm:mk, counts:counts };
  var data = sh.getDataRange().getValues();
  for (var i=1; i<data.length; i++){
    var m=data[i][0], p=data[i][1], c=Number(data[i][2]||0);
    if (m===mk && counts.hasOwnProperty(p)) counts[p]+=c;
  }
  return { yyyymm:mk, counts:counts };
}

function bumpClick_(pid){
  var sh = getSheet_();
  if (!sh) return;
  sh.appendRow([monthKey_(), pid, 1]);
}

function getSheet_(){
  try{
    if (!SPREADSHEET_ID) return null;
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sh = ss.getSheetByName(SHEET_NAME);
    if (!sh){
      sh = ss.insertSheet(SHEET_NAME);
      sh.getRange(1,1,1,3).setValues([['month','pid','count']]);
    }
    return sh;
  }catch(err){
    return null;
  }
}

function monthKey_(){
  var tz = Session.getScriptTimeZone() || TZ;
  return Utilities.formatDate(new Date(), tz, 'yyyy-MM');
}
